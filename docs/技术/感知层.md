# 感知层

## 职责

感知层负责处理多模态输入（语音、图像等），将原始数据转换为统一的 `PerceptionEvent`。

目前实现：
- **STT（语音转文字）**：阿里云 DashScope Paraformer

## 使用方式

### STT 服务

```python
from src.perception.stt import SttRegistry, SttConfig

# 获取服务实例
stt_service = SttRegistry.get_service("aliyun")

# 配置
config = SttConfig(
    model="paraformer-realtime-v2",
    language="zh-CN",
    sample_rate=16000,
    enable_punctuation=True,
)

# 注册回调
stt_service.on_partial(lambda r: print(f"实时: {r.text}"))
stt_service.on_final(lambda r: print(f"最终: {r.text}"))
stt_service.on_ready(lambda: print("准备就绪"))
stt_service.on_error(lambda e: print(f"错误: {e}"))

# 启动会话
await stt_service.start_session("session_001", config)

# 发送音频
for chunk in audio_chunks:
    await stt_service.send_audio(chunk)

# 停止会话
await stt_service.stop_session()
```

### 自定义感知管道

继承 `PerceptionPipeline` 实现新的感知能力：

```python
from src.perception.base import PerceptionPipeline, ModalityType

class VisionPipeline(PerceptionPipeline):
    @property
    def modality(self) -> ModalityType:
        return ModalityType.VISION
    
    async def start(self, session_id: str, config: dict):
        self._session_id = session_id
        self._running = True
    
    async def stop(self):
        self._running = False
    
    async def feed(self, data: bytes):
        # 处理图像数据
        result = await self._process_image(data)
        
        # 发射事件
        event = PerceptionEvent.create(
            session_id=self._session_id,
            modality=ModalityType.VISION,
            source="vision_custom",
            stage=EventStage.FINAL,
            content=result,
        )
        await self._emit(event)
```

## 注意事项

| 注意点 | 说明 |
|-------|-----|
| 回调注册顺序 | 必须在 `start_session()` 前注册回调 |
| 音频格式 | 默认 16kHz PCM，其他格式需转换 |
| 会话复用 | 每个 session_id 只能有一个活跃 STT 会话 |
| 错误处理 | 网络异常会触发 `on_error` 回调 |

## STT 配置项

| 参数 | 默认值 | 说明 |
|-----|-------|-----|
| `model` | `paraformer-realtime-v2` | 模型名称 |
| `language` | `zh-CN` | 语言 |
| `sample_rate` | `16000` | 采样率 |
| `enable_punctuation` | `True` | 启用标点 |
