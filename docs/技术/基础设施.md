# 基础设施

## 职责

基础设施层提供通用能力：
- **日志**：结构化日志 + 阿里云 SLS
- **Nacos**：配置中心 + 服务注册
- **指标**：业务指标追踪

## 使用方式

### 日志

```python
from src.infra import get_logger, log_context, generate_trace_id

logger = get_logger(__name__)

# 基础日志
logger.info("操作完成", user_id="123", action="login")
logger.error("操作失败", exc=exception)

# 链路追踪上下文
with log_context(trace_id=generate_trace_id(), session_id="sess_xxx"):
    logger.info("处理请求")  # 自动带上 trace_id 和 session_id
```

### 配置日志

```python
from src.infra import setup_logging

# 基础配置
setup_logging(level="INFO", format="json")

# 启用 SLS
setup_logging(
    level="INFO",
    format="json",
    sls_config={
        "enabled": True,
        "endpoint": "cn-hangzhou.log.aliyuncs.com",
        "project": "your-project",
        "logstore": "omni-agent",
        "access_key_id": "xxx",
        "access_key_secret": "xxx",
    }
)
```

### Nacos 配置中心

```python
from src.infra import init_nacos_config, get_nacos_config

# 初始化
init_nacos_config(
    server_addr="172.17.150.78:8848",
    namespace="public",
    username="nacos",
    password="xxx",
    group="DEEPKNOW_GROUP",
)

# 读取配置
config = get_nacos_config()
value = config.get_value("omni-agent.yaml", "llm.model")
```

### Nacos 服务注册

```python
from src.infra import init_nacos_registry

registry = init_nacos_registry(
    server_addr="172.17.150.78:8848",
    namespace="public",
    service_name="omni-agent",
    service_port=50051,
    metadata={"protocol": "grpc"},
)

registry.register()    # 注册
registry.deregister()  # 注销
```

### 指标追踪

```python
from src.infra import get_metrics

metrics = get_metrics()

# 追踪事件
metrics.track(
    category="session",
    action="session_created",
    dimensions={"client_id": "app_001"},
    duration_ms=100,
)
```

## 注意事项

| 注意点 | 说明 |
|-------|-----|
| 配置优先级 | Nacos > 环境变量 > 默认值 |
| 日志格式 | 生产用 `json`，开发用 `text` |
| SLS 批量 | 日志批量发送，默认 3 秒或 100 条 |
| trace_id | 跨服务调用需传递 trace_id |

## 环境变量

| 变量 | 默认值 | 说明 |
|-----|-------|-----|
| `LOG_LEVEL` | `INFO` | 日志级别 |
| `LOG_FORMAT` | `text` | 格式：text/json |
| `NACOS_SERVER_ADDR` | - | Nacos 地址 |
| `NACOS_NAMESPACE` | `public` | 命名空间 |
| `NACOS_GROUP` | `DEEPKNOW_GROUP` | 分组 |
