# 编排引擎

## 职责

Orchestrator 是核心编排引擎，协调多模态输入与 Agent 执行，实现端到端任务处理。

主要职责：
- 管理 Task 执行流程
- 协调感知层、推理层、执行层
- 处理多模态输入流
- 触发 Agent 调用时机判断

## 使用方式

### 基础用法：执行单次任务

```python
from src.orchestrator import execute_task
from src.orchestrator.events import ModalityType

async for result in execute_task(
    instruction="帮我分析这段内容",
    input_modalities=[ModalityType.TEXT],
):
    if result["type"] == "thinking":
        print(f"思考中: {result['delta']}", end="")
    elif result["type"] == "answer":
        print(f"\n答案: {result['content']}")
    elif result["type"] == "complete":
        print("任务完成")
```

### 高级用法：处理音频流

```python
from src.orchestrator import Orchestrator
from src.orchestrator.task import Task
from src.orchestrator.events import ModalityType

async def process_audio(audio_stream):
    task = Task(
        task_id="task_xxx",
        instruction="语音助手",
        input_modalities=[ModalityType.AUDIO],
    )
    
    orchestrator = Orchestrator(use_llm_trigger=False)
    
    async for result in orchestrator.execute(task, audio_stream):
        if result["type"] == "perception":
            # STT 识别结果
            event = result["event"]
            print(f"识别: {event['content']}")
        elif result["type"] == "answer":
            print(f"回答: {result['content']}")
```

### 通过 Session 执行

```python
from src.orchestrator import get_session_manager

manager = get_session_manager()
session = manager.create(client_id="app_001")

task = session.create_task(
    instruction="你好",
    input_modalities=[ModalityType.TEXT],
)

# task 自动继承 session 的历史上下文
```

## 注意事项

| 注意点 | 说明 |
|-------|-----|
| 异步迭代器 | `execute()` 返回 AsyncIterator，必须用 `async for` |
| 结果类型 | 根据 `result["type"]` 区分不同事件 |
| 触发判断 | 默认使用规则触发，`use_llm_trigger=True` 用 LLM 判断 |
| 资源清理 | 音频流处理完成后 STT 会话自动关闭 |

## 结果类型

| type | 说明 |
|------|-----|
| `stt_ready` | STT 准备就绪 |
| `perception` | 感知事件（含 event 字段） |
| `thinking` | LLM 思考中（流式 delta） |
| `answer` | 最终回答 |
| `complete` | 任务完成 |
| `error` | 错误 |
