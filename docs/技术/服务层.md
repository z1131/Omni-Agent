# 服务层

## 职责

服务层提供对外接口，支持 gRPC 和 HTTP 双协议：
- **HTTP (FastAPI)**：REST API，端口 8000
- **gRPC**：供 Java 业务服务调用，端口 50051

## 使用方式

### HTTP API

#### 会话管理

```bash
# 创建会话
POST /v1/sessions
{
  "client_id": "app_001",
  "config": {
    "stt": {"model": "paraformer-realtime-v2"},
    "llm": {"model": "qwen-turbo"}
  }
}

# 获取会话
GET /v1/sessions/{session_id}

# 关闭会话
DELETE /v1/sessions/{session_id}
```

#### 对话

```bash
# 流式对话
POST /v1/chat/stream
{
  "session_id": "sess_xxx",
  "message": "你好"
}
# 返回 SSE 流
```

#### 健康检查

```bash
GET /health
# {"status": "healthy", "version": "0.1.0"}
```

### gRPC API

Proto 文件位于 `proto/` 目录：

| Proto | 服务 | 说明 |
|-------|-----|-----|
| `omni_agent.proto` | OmniAgentService | 主服务入口 |
| `stt.proto` | - | STT 双向流 |
| `llm.proto` | - | LLM 流式对话 |
| `multimodal.proto` | - | 多模态处理 |

#### Java 客户端示例

```java
// 创建 channel
ManagedChannel channel = ManagedChannelBuilder
    .forAddress("localhost", 50051)
    .usePlaintext()
    .build();

// 创建 stub
OmniAgentServiceGrpc.OmniAgentServiceStub stub = 
    OmniAgentServiceGrpc.newStub(channel);

// 调用 StreamChat
stub.streamChat(request, new StreamObserver<ChatResponse>() {
    @Override
    public void onNext(ChatResponse response) {
        System.out.println(response.getDelta());
    }
    // ...
});
```

### 启动服务

```bash
# 同时启动 HTTP + gRPC
python -m uvicorn src.main:app --host 0.0.0.0 --port 8000

# 仅启动 gRPC
python -m src.server.grpc.server
```

## 注意事项

| 注意点 | 说明 |
|-------|-----|
| 双协议同步 | HTTP 和 gRPC 接口功能一致 |
| trace_id | 请求头 `X-Trace-ID` 用于链路追踪 |
| gRPC 生成 | 修改 proto 后需重新生成代码 |
| CORS | HTTP 默认允许所有来源（生产应限制） |

## 生成 gRPC 代码

```bash
python -m grpc_tools.protoc \
    -I proto \
    --python_out=src/server/grpc/generated \
    --grpc_python_out=src/server/grpc/generated \
    proto/*.proto
```
