# 部署方案

## 环境配置

### 必需环境变量

| 变量 | 说明 |
|-----|-----|
| `DASHSCOPE_API_KEY` | DashScope API Key（或通过 Nacos 配置） |

### 可选环境变量

| 变量 | 默认值 | 说明 |
|-----|-------|-----|
| `HOST` | `0.0.0.0` | HTTP 监听地址 |
| `PORT` | `8000` | HTTP 端口 |
| `GRPC_ENABLED` | `true` | 启用 gRPC |
| `GRPC_PORT` | `50051` | gRPC 端口 |
| `LOG_LEVEL` | `INFO` | 日志级别 |
| `LOG_FORMAT` | `text` | 日志格式 |
| `NACOS_CONFIG_ENABLED` | `true` | 启用 Nacos 配置 |
| `NACOS_SERVER_ADDR` | `172.17.150.78:8848` | Nacos 地址 |
| `NACOS_NAMESPACE` | `public` | Nacos 命名空间 |
| `NACOS_GROUP` | `DEEPKNOW_GROUP` | Nacos 分组 |

## 本地开发

```bash
# 安装依赖
pip install -r requirements.txt

# 设置 API Key
export DASHSCOPE_API_KEY="your-key"

# 启动服务
python -m uvicorn src.main:app --reload --port 8000
```

## Docker 部署

### 构建镜像

```bash
docker build -t omni-agent .
```

### 本地运行

```bash
docker run -p 8000:8000 -p 50051:50051 \
  -e DASHSCOPE_API_KEY="your-key" \
  omni-agent
```

### 生产部署

使用 `docker-compose.prod.yml`：

```bash
docker compose -f docker-compose.prod.yml up -d
```

## CI/CD 流程

通过 GitHub Actions 自动部署：

```
push to main
    ↓
构建 Docker 镜像
    ↓
推送到阿里云 ACR
    ↓
SSH 到 ECS 拉取并重启
```

### 服务器信息

| 服务器 | IP | 用途 |
|-------|-----|-----|
| ECS-1 | 47.114.90.156 | 生产节点 |
| ECS-2 | 47.99.32.144 | 生产节点 |

### 镜像仓库

```
crpi-16uyo5eg9cykcl2r.cn-hangzhou.personal.cr.aliyuncs.com/omni_agent/omni-agent:latest
```

## 健康检查

```bash
# HTTP
curl http://localhost:8000/health

# 返回
{
  "status": "healthy",
  "version": "0.1.0",
  "sessions_count": 0,
  "nacos_config_enabled": true
}
```

## 端口说明

| 端口 | 协议 | 说明 |
|-----|-----|-----|
| 8000 | HTTP | FastAPI REST API |
| 50051 | gRPC | 业务服务调用 |

## 日志查看

```bash
# Docker 日志
docker logs -f omni-agent

# 阿里云 SLS
# 登录 SLS 控制台查看结构化日志
```
